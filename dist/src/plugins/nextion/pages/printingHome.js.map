{"version":3,"sources":["../../../../../src/plugins/nextion/pages/printingHome.js"],"names":["require","_","PrintingHome","screenManager","isPause","isLifted","options","setup","nanoDLP","getSetup","status","getStatus","confirmResult","confirmType","pause","stop","changePage","console","log","Printing","addListener","command","liftedHeight","manager","unpause","text","returnPage","imageX","imageY","imageWidth","Pause","setScreen","setValue","currentMm","CurrentHeight","MotorDegree","MicroStep","LeadscrewPitch","msg","indexOf","Math","floor","reg","result","match","parseFloat","setText","config","plugins","profiles","getProfiles","targetProfile","selectedIdx","remaining_time","round","LayersCount","LayerID","CureTime","total_time","Path","history","layer","getCurrentPlateLayer","PlateID","image","enabled","nextion","displayBlackWhiteImage","catch","error","e","abstract"],"mappings":"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","file":"printingHome.js","sourcesContent":["require(\"babel-polyfill\");\r\n\r\nimport abstract from \"./abstract.js\";\r\nimport config from \"../../../../config.json\";\r\n\r\nlet _ = null;\r\n\r\nexport default class PrintingHome extends abstract {\r\n\r\n\r\n    constructor(screenManager) {\r\n        super(screenManager);\r\n        this.isPause = null;\r\n        this.isLifted = false;\r\n    }\r\n\r\n    async init(options) {\r\n        if (!this.setup) {\r\n            this.setup = await this.nanoDLP.getSetup();\r\n        }\r\n\r\n        if (!this.status) {\r\n            this.status = await this.nanoDLP.getStatus();\r\n        }\r\n\r\n        try {\r\n            if (options && options.confirmResult && options.confirmResult) {\r\n                switch (options.confirmType) {\r\n                    case \"pause\":\r\n                        this.nanoDLP.pause();\r\n                        break;\r\n\r\n                    case \"stop\":\r\n                        this.nanoDLP.stop();\r\n                        _ = this.changePage(\"home\");\r\n                        break;\r\n                }\r\n            }\r\n        } catch (e) {\r\n        }\r\n        console.log(\"printing status :\"+this.status.Printing);\r\n        this.addListener(\"click_b3\", async () => {\r\n            console.log(\"-----------------pause\");\r\n            if (this.isPause) {\r\n                if (this.isLifted) {\r\n                    await this.nanoDLP.command(`/z-axis/move/down/micron/` + this.liftedHeight);\r\n                    this.isLifted = false;\r\n                }\r\n                this.manager.nanoDLP.unpause();\r\n            } else {\r\n                _ = this.changePage(\"confirm\", {\r\n                    text: \"pause\"\r\n                    , confirmType: \"pause\"\r\n                    , returnPage: \"printingHome\"\r\n                })\r\n            }\r\n        });\r\n\r\n        this.addListener(\"click_b2\", () => {\r\n            console.log(\"-----------------stop\");\r\n            _ = this.changePage(\"confirm\", {\r\n                text: \"stop\"\r\n                , confirmType: \"stop\"\r\n                , returnPage: \"printingHome\"\r\n            });\r\n        });\r\n\r\n        this.addListener(\"click_b1\", () => {\r\n            _ = this.changePage(\"home\");\r\n        });\r\n\r\n        this.addListener(\"click_b19\", () => {\r\n            _ = this.changePage(\"plates\");\r\n        });\r\n    }\r\n\r\n    async update(status, log) {\r\n        if (!status.Printing) {\r\n            return this.changePage(\"home\");\r\n        }\r\n\r\n        this.imageX = 0x5C;//0x08;\r\n        this.imageY = 0x12;//0x3C;\r\n        this.imageWidth = 0x89;\r\n\r\n        if (this.isPause == null || this.isPause !== status.Pause) {\r\n            this.isPause = status.Pause;\r\n            await this.setScreen(\"printing\");\r\n            if (this.isPause) {\r\n                await this.setValue(\"b3\", 1);\r\n            } else {\r\n                await this.setValue(\"b3\", 0);\r\n            }\r\n        }\r\n\r\n        if (!this.setup) {\r\n            this.setup = await this.nanoDLP.getSetup();\r\n        }\r\n\r\n        let currentMm = status.CurrentHeight / ((360 / this.setup.MotorDegree * this.setup.MicroStep) / this.setup.LeadscrewPitch);\r\n        if (currentMm < 0) {\r\n            currentMm = 0;\r\n        }\r\n\r\n\r\n        if (this.isPause && log.msg.indexOf(\"Position set to\") !== -1) {\r\n            this.liftedHeight = Math.floor((150 - currentMm) * 1000 * 10) / 10;\r\n            await this.nanoDLP.command(`/z-axis/move/up/micron/` + this.liftedHeight);\r\n            this.isLifted = true;\r\n        }\r\n\r\n        let reg = /Curing for (\\d+\\.\\d+) seconds/;\r\n        let result = log.msg.match(reg);\r\n        if (result !== null) {\r\n            log.msg = \"Curing for \" + Math.floor(parseFloat(result[1])) + \" seconds\";\r\n        }\r\n\r\n        await this.setText(\"t6\", this.isPause ? \"Pause\" : \"Printing\");\r\n\r\n        this.config = config.plugins.profiles;\r\n\r\n        if (!this.profiles) {\r\n            this.profiles = await this.nanoDLP.getProfiles();\r\n        }\r\n        let targetProfile = this.profiles[this.config.selectedIdx];\r\n\r\n        var remaining_time = Math.round((status.LayersCount - status.LayerID) * (targetProfile.CureTime + 5) / 60);\r\n        var total_time = Math.round(status.LayersCount * (targetProfile.CureTime + 5) / 60);\r\n\r\n        await this.setText(\"t0\", status.LayerID + \"/\" + status.LayersCount);\r\n        await this.setValue(\"j0\", Math.floor((status.LayerID / status.LayersCount) * 100));\r\n        await this.setText(\"t1\", remaining_time + \"/\" + total_time + \"m\");\r\n        await this.setText(\"t2\", log.msg);\r\n        await this.setText(\"t7\", status.Path);\r\n\r\n        if (this.history.layer !== status.LayerID) {\r\n            this.history.layer = status.LayerID;\r\n            let image = await this.nanoDLP.getCurrentPlateLayer(status.PlateID, status.LayerID);\r\n            if (this.enabled) {\r\n                await this.nextion.displayBlackWhiteImage(image, this.imageX, this.imageY, this.imageWidth).catch(e => console.error(e));\r\n            }\r\n        }\r\n\r\n    }\r\n}\r\n"]}