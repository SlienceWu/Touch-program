{"version":3,"sources":["../../../../../src/plugins/nextion/pages/setmodel.js"],"names":["require","_","SetModel","screenManager","options","setScreen","Processed","setText","isExist","serverURL","global","SERVER_URL","Preview","url","PlateID","encoding","image","nextion","displayImage","addListener","saveXYZ","requestTest","XRes","YRes","ZRes","changePage","type","nanoDLP","command","text","Path","confirmType","data0","returnPage","data","request","post","uri","form","headers","Cookie","auth","session","timeout","getValue","x","y","z","transform","params","writeJson","fs","readFile","err","console","error","plate","toString","JSON","parse","i","length","log","key","str","stringify","writeFile","push","total","_this","Boundries","Xmax","Xmin","Ymax","Ymin","Zmax","Zmin","plateID","splice","va","xr","xReal","yr","yReal","zr","zReal","abstract"],"mappings":"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","file":"setmodel.js","sourcesContent":["import request from \"request-promise-native\";\r\n\r\nrequire(\"babel-polyfill\");\r\nimport abstract from \"./abstract.js\";\r\nimport fs from \"fs\";\r\n\r\nlet _ = null;\r\n\r\nexport default class SetModel extends abstract {\r\n\r\n    constructor(screenManager) {\r\n        super(screenManager);\r\n    }\r\n\r\n    async init(options) {\r\n        await this.setScreen(\"setmodel\");\r\n        if (options.Processed){\r\n            await this.setText(\"t11\",\"yes\");\r\n        }else{\r\n            await this.setText(\"t11\",\"no\");\r\n        }\r\n        await this.isExist(options,this);\r\n        this.serverURL = global.SERVER_URL;\r\n\r\n        if (options.Preview){\r\n            let image = await request({ url: `${this.serverURL}/static/plates/${options.PlateID}/3d.png`, encoding: null });\r\n            await this.nextion.displayImage(image);\r\n        }\r\n\r\n        this.addListener(\"click_b1\", () => {\r\n            this.saveXYZ(options);\r\n        });\r\n        this.addListener(\"click_b2\", () => {\r\n            _ = this.requestTest(`${this.serverURL}/plate/regenerate`,{\"PlateID\": options.PlateID,\"XRes\": this.XRes,\"YRes\": this.YRes,\"ZRes\": this.ZRes});\r\n            _ = this.changePage(\"slice\",options);\r\n        });\r\n        this.addListener(\"click_b3\", () => {\r\n            _ = this.changePage(\"plates\",{type:\"stl\",PlateID:options.PlateID});\r\n        });\r\n\r\n        this.addListener(\"click_b4\", async () => {\r\n            if (options.Processed){\r\n                await this.nanoDLP.command(\"/printer/start/\" + options.PlateID);\r\n            }\r\n        });\r\n        this.addListener(\"click_b5\", async () => {\r\n            _ = this.changePage(\"confirm\", {\r\n                text: \"delete plate:\" + options.Path,\r\n                confirmType: \"deleteplate\",\r\n                data0: options.PlateID,\r\n                returnPage: \"plates\"\r\n            });\r\n        });\r\n    }\r\n\r\n    async requestTest(url, data) {\r\n        return request.post({\r\n            uri: url,\r\n            form: data,\r\n            headers:  { Cookie: `${this.auth ?  this.session : \"\"}`},\r\n            timeout: 3000\r\n        });\r\n    }\r\n\r\n    async saveXYZ(options){\r\n        let x = await this.getValue(\"x\");\r\n        let y = await this.getValue(\"y\");\r\n        let z = await this.getValue(\"z\");\r\n\r\n        this.XRes = await this.transform(options,x,\"x\");\r\n        this.YRes = await this.transform(options,y,\"y\");\r\n        this.ZRes = await this.transform(options,z,\"z\");\r\n        let params = {\r\n            \"PlateID\": options.PlateID,\r\n            \"XRes\": this.XRes,\r\n            \"YRes\": this.YRes,\r\n            \"ZRes\": this.ZRes\r\n        };\r\n        this.writeJson(params);\r\n    }\r\n\r\n    async writeJson(params){ //先将json文件读出来\r\n        fs.readFile(`/home/pi/nextion/bin/plugins/nextion/pages/setmodel.json`,async function(err,data){\r\n            if(err){\r\n                return console.error(err);\r\n            }\r\n            let plate = data.toString();\r\n            plate = JSON.parse(plate);\r\n            for(let i = 0; i < plate.data.length;i++){\r\n                if(params.PlateID == plate.data[i].PlateID){\r\n                    console.log('id is exist');\r\n                    for(let key in params){\r\n                        if(plate.data[i][key]){\r\n                            plate.data[i][key] = params[key];\r\n                        }\r\n                    }\r\n                    let str = JSON.stringify(plate);\r\n                    fs.writeFile(`/home/pi/nextion/bin/plugins/nextion/pages/setmodel.json`,str,async function(err){\r\n                        if(err){\r\n                            console.error(err);\r\n                        }\r\n                        console.log('----------修改成功-------------');\r\n                    });\r\n                    return;\r\n                }\r\n            }\r\n            plate.data.push(params);\r\n            plate.total = plate.data.length;\r\n            let str = JSON.stringify(plate);\r\n            fs.writeFile(`/home/pi/nextion/bin/plugins/nextion/pages/setmodel.json`,str,async function(err){\r\n                if(err){\r\n                    console.error(err);\r\n                }\r\n                console.log('----------新增成功-------------');\r\n            })\r\n        });\r\n    }\r\n\r\n    async isExist(options,_this){\r\n        fs.readFile(`/home/pi/nextion/bin/plugins/nextion/pages/setmodel.json`,async function(err,data){\r\n            if(err){\r\n                console.error(err);\r\n            }\r\n            let plate = data.toString();\r\n            plate = JSON.parse(plate);\r\n            for(let i = 0; i < plate.data.length;i++){\r\n                if(options.PlateID == plate.data[i].PlateID){\r\n                    console.log('set is Exist');\r\n                    _this.setText(\"t1\", await _this.transform(options, plate.data[i].XRes, \"x\"));\r\n                    _this.setText(\"t2\", await _this.transform(options, plate.data[i].YRes, \"y\"));\r\n                    _this.setText(\"t3\", await _this.transform(options, plate.data[i].ZRes, \"z\"));\r\n                    _this.XRes = plate.data[i].XRes;\r\n                    _this.YRes = plate.data[i].YRes;\r\n                    _this.ZRes = plate.data[i].ZRes;\r\n                    return;\r\n                }\r\n            }\r\n            _this.setText(\"t1\", (options.Boundries.Xmax - options.Boundries.Xmin));\r\n            _this.setText(\"t2\", (options.Boundries.Ymax - options.Boundries.Ymin));\r\n            _this.setText(\"t3\", (options.Boundries.Zmax - options.Boundries.Zmin));\r\n            _this.XRes = options.XRes;\r\n            _this.YRes = options.YRes;\r\n            _this.ZRes = options.ZRes;\r\n        })\r\n    }\r\n\r\n    async deleteJson(plateID){\r\n        fs.readFile(`/home/pi/nextion/bin/plugins/nextion/pages/setmodel.json`,async function(err,data){\r\n            if(err){\r\n                return console.error(error);\r\n            }\r\n            let plate = data.toString();\r\n            plate = JSON.parse(plate);\r\n            for(let i = 0; i < plate.data.length;i++) {\r\n                if (plateID == plate.data[i].PlateID){\r\n                    plate.data.splice(i,1);\r\n                }\r\n            }\r\n            plate.total = plate.data.length;\r\n            let str = JSON.stringify(plate);\r\n            fs.writeFile(`/home/pi/nextion/bin/plugins/nextion/pages/setmodel.json`,str,async function(err){\r\n                if(err){\r\n                    console.error(err);\r\n                }\r\n                console.log('----------删除成功-------------');\r\n            })\r\n        })\r\n    }\r\n    \r\n    async transform(options, va, str){\r\n        if ( str === \"x\"){\r\n            let x = options.Boundries.Xmax - options.Boundries.Xmin;\r\n            let xr = options.XRes;\r\n            let xReal = (xr * x) / va;\r\n            return xReal;\r\n        } else if ( str === \"y\" ){\r\n            let y = options.Boundries.Ymax - options.Boundries.Ymin;\r\n            let yr = options.YRes;\r\n            let yReal = (yr * y) / va;\r\n            return yReal;\r\n        } else {\r\n            let z = options.Boundries.Zmax - options.Boundries.Zmin;\r\n            let zr = options.ZRes;\r\n            let zReal = (zr * z) / va;\r\n            return zReal;\r\n        }\r\n    }\r\n}"]}